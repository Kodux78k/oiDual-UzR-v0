<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>DUAL // MONOLITH · Navigator · Infodose</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#020202">
  <link rel="apple-touch-icon" href="./icon-192.png">

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js')
        .then(() => console.log('Service Worker Registered'))
        .catch(()=>{});
    }
  </script>

  <meta name="description" content="Ambiente de navegação imersivo DUAL System">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;400;500;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <script src="https://unpkg.com/lucide@latest"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            ui: ['Inter', 'sans-serif'],
            code: ['JetBrains Mono', 'monospace'],
          },
          colors: {
            dual: {
              bg: '#020202',
              glass: 'rgba(10, 10, 12, 0.75)',
              border: 'rgba(255, 255, 255, 0.08)',
              cyan: '#00f2ff',
              purple: '#bd00ff',
              alert: '#ff4d4d',
            }
          },
          animation: {
            'scan': 'scan 3s linear infinite',
            'spin-slow': 'spin 8s linear infinite',
            'pulse-glow': 'pulseGlow 3s ease-in-out infinite',
            'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
          },
          keyframes: {
            scan: {
              '0%': { transform: 'translateX(-100%)' },
              '100%': { transform: 'translateX(200%)' }
            },
            pulseGlow: {
              '0%, 100%': { opacity: '0.4' },
              '50%': { opacity: '1' }
            },
            slideUp: {
              '0%': { transform: 'translateY(20px)', opacity: '0' },
              '100%': { transform: 'translateY(0)', opacity: '1' }
            }
          }
        }
      }
    }
  </script>

  <style>
    /* =========================
       CUSTOM STYLES & EFFECTS
       ========================= */
    :root {
      --glass-surface: rgba(15, 15, 20, 0.65);
      --glass-border: rgba(255, 255, 255, 0.08);
      --neon-cyan: #00f2ff;
    }

    body {
      background-color: #020202;
      overflow: hidden;
    }

    /* Ambient Background */
    .void-ambient {
      position: fixed; inset: 0; z-index: 0; pointer-events: none;
      background:
        radial-gradient(circle at 20% 120%, rgba(189,0,255,0.08), transparent 50%),
        radial-gradient(circle at 80% -20%, rgba(0,242,255,0.05), transparent 50%);
      transition: opacity 1s ease;
    }

    /* Scrollbar Customization */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

    /* Monolith 3D Effect */
    .monolith-wrapper {
      perspective: 1200px;
      transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1);
    }

    .monolith {
      background: var(--glass-surface);
      backdrop-filter: blur(24px) saturate(180%);
      -webkit-backdrop-filter: blur(24px) saturate(180%);
      border: 1px solid var(--glass-border);
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
      transform-style: preserve-3d;
      opacity: 0;
      transform: translateY(60px) rotateX(10deg) scale(0.95);
      transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
      pointer-events: none;
    }

    body.system-active .monolith {
      opacity: 1;
      transform: translateY(0) rotateX(0) scale(1);
      pointer-events: auto;
    }

    /* Runtime Layer Transition */
    .runtime-layer {
      transform: translateY(100%);
      transition: transform 0.5s cubic-bezier(0.76, 0, 0.24, 1);
    }
    .runtime-layer.visible { transform: translateY(0); }

    /* Orb Styles (SMALLER) */
    .orb-container {
      transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1), bottom 0.5s ease;
    }
    body.system-active .orb-container {
      transform: translateX(-50%) scale(0.8);
      bottom: 2rem;
    }

    .orb {
      background: rgba(5, 5, 10, 0.6);
      backdrop-filter: blur(12px);
      box-shadow: 0 0 0 1px rgba(255,255,255,0.06), 0 0 10px rgba(0, 242, 255, 0.08);
      transition: all 0.25s ease;
      border-radius: 9999px;
    }
    .orb:hover {
      box-shadow: 0 0 0 1px rgba(0, 242, 255, 0.45), 0 0 28px rgba(0, 242, 255, 0.25);
      transform: scale(1.06);
    }

    /* Editor Modal */
    .editor-overlay {
      position: fixed; inset: 0; z-index: 80; display: none;
      background: rgba(0,0,0,0.7); backdrop-filter: blur(6px); align-items: center; justify-content: center;
    }
    .editor-overlay.active { display: flex; }
    .editor-box {
      width: min(1100px, 96%); height: min(720px, 92%); background: #071018; border-radius: 12px; overflow: hidden;
      border: 1px solid rgba(255,255,255,0.06); box-shadow: 0 20px 60px rgba(0,0,0,0.7); display:flex; flex-direction:column;
    }
    .editor-top { display:flex; align-items:center; justify-content:space-between; padding:10px 14px; background:#071017; border-bottom:1px solid #0d0d0f; }
    .editor-title { color: #9fdcff; font-family: monospace; font-size: 13px; letter-spacing: 1px; }
    .editor-area { flex:1; padding:12px; display:flex; gap:12px; }
    .editor-area textarea { width:100%; height:100%; resize:none; background: #04101a; color:#dfefff; border:1px solid rgba(255,255,255,0.04); border-radius:8px; padding:12px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "JetBrains Mono", monospace; font-size:13px; line-height:1.45; }
    .editor-actions { display:flex; gap:8px; align-items:center; }
    .editor-footer { padding:10px; display:flex; gap:8px; justify-content:flex-end; border-top:1px solid rgba(255,255,255,0.02); background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.2)); }

    /* Themes */
    body.theme-light { background: #e0e0e0; color: #111; }
    body.theme-light .monolith { background: rgba(255,255,255,0.85); border-color: rgba(0,0,0,0.1); }
    body.theme-light .orb { background: rgba(255,255,255,0.8); border-color: rgba(0,0,0,0.2); }
    body.theme-vibe { background: radial-gradient(circle at center, #2b1055, #000); }

    /* Utility Classes for JS toggles */
    .hidden-force { display: none !important; }
    .scanline {
      background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
      background-size: 100% 4px;
      pointer-events: none;
    }
  </style>
</head>
<body class="antialiased text-white selection:bg-dual-cyan selection:text-black">

  <!-- Ambient Background -->
  <div class="void-ambient w-full h-full" aria-hidden="true"></div>

  <!-- Background Navigator Iframe -->
  <iframe id="navFrame" src="./index.html" title="Navigator Background" class="fixed inset-0 w-full h-full border-0 z-0 bg-black transition-opacity duration-300"></iframe>

  <!-- Top Controls (inclui botão de Edição) -->
  <div class="fixed top-6 left-1/2 -translate-x-1/2 z-50 flex items-center gap-4">
    <button id="themeToggle" class="w-9 h-9 rounded-full bg-dual-glass border border-dual-border flex items-center justify-center hover:bg-white/10 transition-colors backdrop-blur-md text-dual-cyan shadow-lg" title="Mudar Tema">
      <i class="fa-solid fa-circle-half-stroke text-lg"></i>
    </button>

    <!-- Header Edit Button -->
    <button id="openEditorBtn" class="w-auto h-9 px-3 rounded-full bg-white/6 border border-white/6 hover:bg-white/10 transition-colors backdrop-blur-md text-sm text-dual-cyan font-code flex items-center gap-2" title="Editar HTML da página">
      <i class="fa-solid fa-code"></i>
      Editar Página
    </button>
  </div>

  <!-- Right Sidebar (Symbol Bar) -->
  <div class="fixed right-2 top-1/2 -translate-y-1/2 flex flex-col gap-2 z-40">
    <button class="w-8 h-8 rounded-lg bg-black/40 border border-white/5 text-dual-cyan hover:bg-dual-cyan hover:text-black transition-all backdrop-blur-sm flex items-center justify-center font-code" data-url="about:blank" title="Blank">Φ</button>
    <button class="w-8 h-8 rounded-lg bg-black/40 border border-white/5 text-dual-cyan hover:bg-dual-cyan hover:text-black transition-all backdrop-blur-sm flex items-center justify-center font-code" data-url="https://kodux78k.github.io/oiDual-Vivivi-1/" title="Vivivi">꩜</button>
    <button class="w-8 h-8 rounded-lg bg-black/40 border border-white/5 text-dual-cyan hover:bg-dual-cyan hover:text-black transition-all backdrop-blur-sm flex items-center justify-center font-code" data-url="https://kodux78k.github.io/NosSolar-dualInfodose/" title="Nosolar">☼</button>
    <button class="w-8 h-8 rounded-lg bg-black/40 border border-white/5 text-dual-cyan hover:bg-dual-cyan hover:text-black transition-all backdrop-blur-sm flex items-center justify-center font-code" data-url="https://kodux78k.github.io/DualInfodose-VirgemHuB/index.html" title="Atelie">◧</button>
  </div>

  <!-- Left Sidebar (Tools) -->
  <div class="fixed left-2 top-1/3 flex flex-col gap-2 z-40">
    <button id="uploadBtn" class="tool-btn w-8 h-8 rounded-lg bg-black/40 border border-white/5 text-gray-400 hover:text-white hover:border-dual-cyan/50 transition-all backdrop-blur-sm flex items-center justify-center" title="Upload HTML">
      <i class="fa-solid fa-file-import"></i>
    </button>
    <input id="uploadHTML" type="file" accept=".html" class="hidden">
    
    <button id="remoteBtn" class="tool-btn w-8 h-8 rounded-lg bg-black/40 border border-white/5 text-gray-400 hover:text-white hover:border-dual-cyan/50 transition-all backdrop-blur-sm flex items-center justify-center" title="Abrir URL">
      <i class="fa-solid fa-globe"></i>
    </button>
    
    <button id="decoderToggle" class="tool-btn w-8 h-8 rounded-lg bg-black/40 border border-white/5 text-gray-400 hover:text-white hover:border-dual-cyan/50 transition-all backdrop-blur-sm flex items-center justify-center" title="Decoder">
      <i class="fa-solid fa-key"></i>
    </button>
    
    <button id="ritualBtn" class="tool-btn w-8 h-8 rounded-lg bg-black/40 border border-white/5 text-dual-purple hover:text-white hover:border-dual-purple transition-all backdrop-blur-sm flex items-center justify-center" title="Ritual">
      <i class="fa-solid fa-wand-magic-sparkles"></i>
    </button>
  </div>

  <!-- Footer Navigation Dots -->
  <div class="fixed bottom-4 left-1/2 -translate-x-1/2 flex gap-3 z-40">
    <button id="dot-index" class="w-3 h-3 rounded-full bg-white/10 hover:bg-dual-cyan border border-transparent hover:border-dual-cyan transition-all" title="Index"></button>
    <button id="dot-base" class="w-4 h-4 rounded-full bg-transparent border border-dual-cyan shadow-[0_0_10px_rgba(0,242,255,0.25)] hover:bg-dual-cyan hover:shadow-[0_0_18px_rgba(0,242,255,0.45)] transition-all" title="Reset Base"></button>
    <button id="dot-last" class="w-3 h-3 rounded-full bg-white/10 hover:bg-dual-cyan border border-transparent hover:border-dual-cyan transition-all" title="Última Página"></button>
  </div>

  <!-- Decoder Modal (Absolute) -->
  <div id="decoderBox" class="fixed top-24 left-1/2 -translate-x-1/2 z-50 bg-black/90 border border-white/10 p-3 rounded-xl backdrop-blur-xl shadow-2xl hidden animate-slide-up">
    <div class="flex items-center gap-2">
      <span class="text-dual-cyan font-code text-xs mr-2">://DECODER</span>
      <input id="codeInput" type="text" placeholder="INSIRA O SELO" class="bg-white/5 border border-white/10 rounded px-3 py-1 text-sm font-code text-white focus:border-dual-cyan focus:outline-none uppercase w-32">
      <button id="decodeBtn" class="bg-white/10 hover:bg-dual-cyan hover:text-black px-3 py-1 rounded text-sm font-bold transition-colors">ABRIR</button>
      <button id="closeDecoder" class="text-gray-500 hover:text-white px-2"><i class="fa-solid fa-xmark"></i></button>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 px-4 py-2 rounded-lg bg-black/80 border border-dual-cyan/30 text-dual-cyan font-code text-sm shadow-xl z-[100] transition-all duration-300 opacity-0 pointer-events-none translate-y-[-10px]">
    <span id="toastMsg">System Ready</span>
  </div>

  <!-- Orb Trigger (Bottom · even smaller) -->
  <div class="orb-container fixed bottom-4 left-1/2 -translate-x-1/2 z-[60]">
    <button
      id="orbBtn"
      class="orb w-8 h-8 rounded-full flex items-center justify-center relative group"
      aria-label="Toggle Monolith"
    >
      <!-- núcleo -->
      <div class="orb-core w-1 h-1 bg-white rounded-full
        shadow-[0_0_8px_white]
        transition-all
        group-hover:bg-dual-cyan
        group-hover:shadow-[0_0_12px_#00f2ff]">
      </div>

      <!-- anel externo -->
      <div class="absolute inset-0.5 rounded-full
        border border-t-dual-cyan/60
        border-r-transparent border-b-transparent border-l-transparent
        animate-spin-slow opacity-60" style="transform-origin:center center;">
      </div>

      <!-- anel interno -->
      <div class="absolute inset-1.5 rounded-full
        border border-b-dual-purple/60
        border-l-transparent border-t-transparent border-r-transparent
        animate-spin-slow opacity-35"
        style="animation-direction: reverse;">
      </div>
    </button>
  </div>

  <!-- MONOLITH CARD (Main UI) -->
  <div class="monolith-wrapper fixed inset-0 z-[55] flex items-center justify-center pointer-events-none p-4">
    <div class="monolith w-full max-w-4xl h-[75vh] max-h-[800px] rounded-3xl flex flex-col overflow-hidden relative">
      
      <!-- Header -->
      <div class="flex justify-between items-center px-6 py-4 border-b border-white/5 bg-white/5">
        <div class="flex items-center gap-2 font-ui font-bold tracking-wider text-sm">
          <i data-lucide="layers" class="text-dual-cyan w-4 h-4"></i>
          DUAL <span class="text-white/40">//</span> MONO
        </div>
        <div class="flex items-center gap-3">
          <div id="sysStatus" class="font-code text-xs px-3 py-1 rounded bg-white/5 border border-white/5 text-gray-400">
            STANDBY
          </div>
          <button id="quickEditBtn" class="text-xs px-3 py-1 rounded bg-white/6 border border-white/6 hover:bg-white/10 font-code">Abrir Editor</button>
        </div>
      </div>

      <!-- Main Stage -->
      <div class="flex-1 p-6 overflow-y-auto flex flex-col gap-4 relative">
        <p class="text-xs text-gray-500 font-code mb-2">:: SISTEMA NOMINAL // SELECIONE O VETOR ::</p>

        <!-- Drop Zone -->
        <div id="dropZone" class="h-32 rounded-2xl border border-dashed border-white/10 bg-black/20 hover:bg-dual-cyan/5 hover:border-dual-cyan/40 transition-all cursor-pointer flex flex-col items-center justify-center gap-2 group">
          <i data-lucide="upload-cloud" class="text-gray-500 group-hover:text-dual-cyan transition-colors"></i>
          <span class="font-bold text-gray-400 group-hover:text-white text-sm">Carregar Stack / Módulo</span>
          <span id="fileName" class="text-[10px] text-gray-600 font-code uppercase">.HTML, .JSON, .JS</span>
          <input type="file" id="fileInput" hidden accept=".html,.json,.js" />
        </div>

        <!-- Action Buttons -->
        <div class="grid grid-cols-2 gap-3 mt-2">
          <button id="infodoseBtn" class="flex items-center justify-center gap-2 p-3 rounded-xl bg-white/5 border border-white/5 hover:bg-white/10 hover:border-dual-cyan/30 transition-all text-sm font-semibold">
            <i data-lucide="zap" class="w-4 h-4 text-dual-cyan"></i> Infodose
          </button>
          <button id="artRaskBtn" class="flex items-center justify-center gap-2 p-3 rounded-xl bg-white/5 border border-white/5 hover:bg-white/10 hover:border-dual-purple/30 transition-all text-sm font-semibold">
            <i data-lucide="cpu" class="w-4 h-4 text-dual-purple"></i> ArtRask
          </button>
        </div>

        <!-- Stack List -->
        <div id="stackList" class="flex flex-col gap-2 mt-4 pb-10">
          <!-- Items injected via JS -->
        </div>
      </div>

      <!-- Pulse Bar -->
      <div class="h-1 w-full bg-black/50 mt-auto relative overflow-hidden opacity-50">
        <div id="pulseBar" class="absolute inset-y-0 left-0 w-1/2 bg-gradient-to-r from-transparent via-dual-cyan to-transparent animate-scan opacity-0 transition-opacity duration-500"></div>
      </div>

      <!-- Runtime Layer (Overlay inside Monolith) -->
      <div id="runtimeLayer" class="runtime-layer absolute inset-0 bg-black z-20 flex flex-col">
        <div class="h-10 bg-[#0a0a0c] border-b border-white/10 flex items-center justify-between px-4">
          <span class="font-code text-xs text-dual-cyan">RUNTIME // SANDBOX</span>
          <div class="flex items-center gap-2">
            <button id="openInFrameBtn" class="text-[10px] bg-white/10 hover:bg-white/20 px-2 py-1 rounded transition-colors">EXPANDIR</button>
            <button id="closeRuntimeBtn" class="text-gray-400 hover:text-white transition-colors">
              <i data-lucide="x" class="w-4 h-4"></i>
            </button>
          </div>
        </div>
        <div class="flex-1 relative bg-white">
          <iframe id="appFrame" class="w-full h-full border-0" sandbox="allow-scripts allow-forms allow-modals allow-same-origin"></iframe>
          <div class="scanline absolute inset-0 pointer-events-none opacity-20 mix-blend-overlay"></div>
        </div>
      </div>

    </div>
  </div>

  <!-- HTML Editor Modal -->
  <div id="htmlEditorModal" class="editor-overlay" aria-hidden="true">
    <div class="editor-box" role="dialog" aria-modal="true" aria-labelledby="editorTitle">
      <div class="editor-top">
        <div class="editor-title" id="editorTitle">HTML EDITOR — PAGINA ATUAL</div>
        <div class="editor-actions">
          <button id="loadFromFrame" class="px-3 py-1 rounded bg-white/6 border border-white/6 hover:bg-white/10 text-sm font-code">Carregar do Frame</button>
          <button id="applyToFrame" class="px-3 py-1 rounded bg-dual-cyan text-black hover:brightness-95 text-sm font-semibold">Aplicar</button>
          <button id="downloadHTML" class="px-3 py-1 rounded bg-white/6 border border-white/6 hover:bg-white/10 text-sm font-code">Baixar</button>
          <button id="closeEditor" class="px-2 py-1 rounded bg-transparent text-gray-400 hover:text-white" title="Fechar">✖</button>
        </div>
      </div>
      <div class="editor-area">
        <textarea id="htmlEditorTextarea" spellcheck="false" placeholder="HTML da página — carregue do frame ou cole seu HTML aqui"></textarea>
      </div>
      <div class="editor-footer">
        <label class="text-xs text-gray-400 font-code mr-auto">Modo: Editar HTML bruto • Salve com cuidado.</label>
        <button id="saveAsModule" class="px-3 py-1 rounded bg-white/6 border border-white/6 hover:bg-white/10 text-sm font-code">Salvar como Módulo</button>
      </div>
    </div>
  </div>

  <!-- Web Component for Modals -->
  <script>
    class MyFrameLoader extends HTMLElement {
      constructor(){
        super();
        this.attachShadow({mode:'open'});
        this.shadowRoot.innerHTML = `
          <style>
            :host { all: initial; font-family: sans-serif; }
            .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center; z-index: 99999; animation: fadeIn 0.2s; }
            .box { width: 90%; height: 85%; background: #071017; border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 0 50px rgba(0,0,0,0.8); transform: scale(0.95); animation: zoomIn 0.2s forwards; }
            .top { display: flex; justify-content: space-between; align-items: center; padding: 10px 16px; background: #000; border-bottom: 1px solid #222; }
            .title { color: #888; font-size: 12px; font-family: monospace; }
            button { background: none; border: none; color: #fff; font-size: 18px; cursor: pointer; opacity: 0.7; transition: 0.2s; }
            button:hover { opacity: 1; color: #ff4d4d; }
            iframe { flex: 1; border: 0; width: 100%; height: 100%; background: #fff; }
            @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
            @keyframes zoomIn { to { transform: scale(1); } }
          </style>
          <div class="overlay">
            <div class="box">
              <div class="top">
                <span class="title">EXTERNAL // LOADER</span>
                <button class="close" title="Fechar">✖</button>
              </div>
              <iframe sandbox="allow-scripts allow-same-origin allow-forms"></iframe>
            </div>
          </div>
        `;
        this.iframe = this.shadowRoot.querySelector('iframe');
        this.shadowRoot.querySelector('.close').onclick = () => this.remove();
        this.shadowRoot.querySelector('.overlay').onclick = (e) => { if(e.target === e.currentTarget) this.remove(); };
      }
      set src(v){ this.iframe.src = v; }
    }
    customElements.define('my-frame-loader', MyFrameLoader);
  </script>

  <!-- Application Logic -->
  <script>
    const App = {
      config: {
        storageKey: 'dual_last_page',
        stacksKey: 'dual_stacks_v2',
        themeKey: 'dual_theme',
        stateKey: 'dual_monolith_active',
        codeMap: {
          "DUAL": "menu.html",
          "KBX": "menu-x-1.html",
          "ATVR": "render-response.html",
          "337": "KOBLLUX_MetaLux_CLEANED.html"
        }
      },
      
      state: {
        active: false,
        stacks: [],
        infodose: false
      },

      refs: {
        body: document.body,
        navFrame: document.getElementById('navFrame'),
        sysStatus: document.getElementById('sysStatus'),
        stackList: document.getElementById('stackList'),
        pulseBar: document.getElementById('pulseBar'),
        orbBtn: document.getElementById('orbBtn'),
        toast: document.getElementById('toast'),
        toastMsg: document.getElementById('toastMsg'),
        runtimeLayer: document.getElementById('runtimeLayer'),
        appFrame: document.getElementById('appFrame'),
        htmlEditorModal: document.getElementById('htmlEditorModal'),
        htmlEditorTextarea: document.getElementById('htmlEditorTextarea'),
      },

      init() {
        this.loadSettings();
        this.loadStacks();
        this.bindEvents();
        this.createIcons();
        
        const wasActive = localStorage.getItem(this.config.stateKey) === 'true';
        if (wasActive) {
          setTimeout(() => this.toggleSystem(true), 600);
        } else {
          this.toggleSystem(false);
        }
        console.log("%c DUAL // SYSTEM READY ", "background: #000; color: #00f2ff; font-weight: bold; padding: 4px; border: 1px solid #00f2ff;");
      },

      createIcons() {
        if(window.lucide) lucide.createIcons();
      },

      loadSettings() {
        // Theme
        const theme = localStorage.getItem(this.config.themeKey) || 'dark';
        this.setTheme(theme);
        
        // Last Page
        const lastPage = localStorage.getItem(this.config.storageKey);
        if(lastPage) this.refs.navFrame.src = lastPage;
        
        // Frame persistence
        this.refs.navFrame.onload = () => {
          try {
             const href = this.refs.navFrame.contentWindow.location.href;
             if(href !== 'about:blank') localStorage.setItem(this.config.storageKey, href);
          } catch(e) {
             localStorage.setItem(this.config.storageKey, this.refs.navFrame.src);
          }
        };
      },

      setTheme(themeName) {
        this.refs.body.className = this.refs.body.className.replace(/theme-\w+/g, '');
        if(themeName !== 'dark') this.refs.body.classList.add(`theme-${themeName}`);
        localStorage.setItem(this.config.themeKey, themeName);
      },

      toggleTheme() {
        const current = localStorage.getItem(this.config.themeKey) || 'dark';
        const themes = ['dark', 'light', 'vibe'];
        const next = themes[(themes.indexOf(current) + 1) % themes.length];
        this.setTheme(next);
        this.showToast(`TEMA: ${next.toUpperCase()}`);
      },

      toggleSystem(forceState) {
        this.state.active = forceState !== undefined ? forceState : !this.state.active;
        if(this.state.active) {
          this.refs.body.classList.add('system-active');
          this.refs.sysStatus.innerText = "READY";
          this.refs.sysStatus.className = "font-code text-xs px-3 py-1 rounded bg-dual-cyan/10 border border-dual-cyan/30 text-dual-cyan";
        } else {
          this.refs.body.classList.remove('system-active');
          this.refs.sysStatus.innerText = "STANDBY";
          this.refs.sysStatus.className = "font-code text-xs px-3 py-1 rounded bg-white/5 border border-white/5 text-gray-400";
        }
      },

      showToast(msg, duration = 2000) {
        this.refs.toastMsg.innerText = msg;
        this.refs.toast.classList.remove('opacity-0', 'translate-y-[-10px]');
        this.refs.toast.style.pointerEvents = 'auto';
        clearTimeout(this.toastTimer);
        this.toastTimer = setTimeout(() => {
          this.refs.toast.classList.add('opacity-0', 'translate-y-[-10px]');
          this.refs.toast.style.pointerEvents = 'none';
        }, duration);
      },

      // --- STACK MANAGEMENT ---

      loadStacks() {
        try {
          const raw = localStorage.getItem(this.config.stacksKey);
          if(raw) this.state.stacks = JSON.parse(raw);
          this.renderStacks();
        } catch(e) { console.error("Stack load error", e); }
      },

      saveStacks() {
        localStorage.setItem(this.config.stacksKey, JSON.stringify(this.state.stacks));
      },

      addStack(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          const newStack = {
            id: Date.now(),
            title: file.name,
            content: e.target.result,
            date: new Date().toLocaleDateString()
          };
          this.state.stacks.unshift(newStack);
          this.saveStacks();
          this.renderStacks();
          this.showToast("MÓDULO INTEGRADO");
          document.getElementById('fileName').innerText = file.name;
        };
        reader.readAsText(file);
      },

      removeStack(id) {
        if(confirm("Desintegrar este módulo?")) {
          this.state.stacks = this.state.stacks.filter(s => s.id !== id);
          this.saveStacks();
          this.renderStacks();
        }
      },

      runStack(id) {
        const stack = this.state.stacks.find(s => s.id === id);
        if(!stack) return;
        
        this.refs.appFrame.srcdoc = stack.content;
        this.refs.runtimeLayer.classList.add('visible');
        this.refs.sysStatus.innerText = "RUNNING";
        this.refs.sysStatus.classList.add('animate-pulse');
      },

      closeRuntime() {
        this.refs.runtimeLayer.classList.remove('visible');
        this.refs.sysStatus.classList.remove('animate-pulse');
        this.refs.sysStatus.innerText = "READY";
        setTimeout(() => { this.refs.appFrame.srcdoc = ''; }, 500);
      },

      renderStacks() {
        const list = this.refs.stackList;
        list.innerHTML = '';
        
        if(this.state.stacks.length === 0) {
          list.innerHTML = `<div class="text-center py-6 text-gray-600 font-code text-xs">NENHUM DADO ENCONTRADO</div>`;
          return;
        }

        this.state.stacks.forEach(stack => {
          const el = document.createElement('div');
          el.className = "flex items-center justify-between p-3 rounded-xl bg-white/5 border border-white/5 hover:border-dual-cyan/30 transition-all group cursor-pointer";
          el.innerHTML = `
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 rounded-lg bg-black/40 flex items-center justify-center text-dual-cyan/70 group-hover:text-dual-cyan">
                <i data-lucide="package" class="w-4 h-4"></i>
              </div>
              <div>
                <div class="font-bold text-sm text-gray-200 group-hover:text-white">${stack.title}</div>
                <div class="text-[10px] text-gray-500 font-code">${stack.date}</div>
              </div>
            </div>
            <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
              <button class="run-btn w-8 h-8 rounded-lg bg-dual-cyan text-black flex items-center justify-center hover:bg-white transition-colors" title="Executar">
                <i data-lucide="play" class="w-3 h-3 fill-current"></i>
              </button>
              <button class="del-btn w-8 h-8 rounded-lg border border-red-500/30 text-red-500 hover:bg-red-500 hover:text-white flex items-center justify-center transition-colors" title="Apagar">
                <i data-lucide="trash-2" class="w-3 h-3"></i>
              </button>
            </div>
          `;
          
          el.querySelector('.run-btn').onclick = (e) => { e.stopPropagation(); this.runStack(stack.id); };
          el.querySelector('.del-btn').onclick = (e) => { e.stopPropagation(); this.removeStack(stack.id); };
          el.onclick = () => this.runStack(stack.id);
          
          list.appendChild(el);
        });
        
        this.createIcons();
      },

      // --- HTML EDITOR FEATURES ---

      openEditor() {
        this.refs.htmlEditorModal.classList.add('active');
        this.refs.htmlEditorTextarea.focus();
        // Try to preload with last saved edited HTML if any
        const lastHTML = localStorage.getItem('dual_html_editor_last');
        if(lastHTML) {
          this.refs.htmlEditorTextarea.value = lastHTML;
        }
      },

      closeEditor() {
        this.refs.htmlEditorModal.classList.remove('active');
      },

      loadHtmlFromNavFrame() {
        try {
          // If same origin, read real DOM; otherwise read src (srcdoc or src)
          const doc = this.refs.navFrame.contentDocument || this.refs.navFrame.contentWindow.document;
          const html = doc.documentElement.outerHTML;
          this.refs.htmlEditorTextarea.value = html;
          this.showToast("HTML carregado do frame");
        } catch (e) {
          // Cross-origin: try fetch current src
          const src = this.refs.navFrame.src;
          if(src && !src.startsWith('about:')) {
            fetch(src).then(r=>r.text()).then(txt=>{
              this.refs.htmlEditorTextarea.value = txt;
              this.showToast("HTML remoto carregado (fetch)");
            }).catch(()=> {
              this.refs.htmlEditorTextarea.value = `<!-- Não foi possível carregar (cross-origin). Cole o HTML aqui. -->`;
              this.showToast("Falha ao carregar (CORS)");
            });
          } else {
            this.refs.htmlEditorTextarea.value = `<!-- Nenhum conteúdo disponível. Cole o HTML aqui. -->`;
            this.showToast("Conteúdo não acessível");
          }
        }
      },

      applyHtmlToNavFrame() {
        const html = this.refs.htmlEditorTextarea.value || '';
        // Save last editor content
        localStorage.setItem('dual_html_editor_last', html);
        // Prefer srcdoc for reliability
        try {
          // If it's large, create blob to preserve URLs relative behavior
          const blob = new Blob([html], { type: 'text/html' });
          const url = URL.createObjectURL(blob);
          this.refs.navFrame.src = url;
          this.showToast("Aplicado ao Navigator (src blob)");
        } catch (e) {
          // Fallback to srcdoc if supported
          try {
            this.refs.navFrame.srcdoc = html;
            this.showToast("Aplicado via srcdoc");
          } catch (err) {
            this.showToast("Falha ao aplicar HTML");
            console.error(err);
          }
        }
      },

      downloadEditorHtml() {
        const html = this.refs.htmlEditorTextarea.value || '<!-- vazio -->';
        const blob = new Blob([html], { type: 'text/html' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'page-edit.html';
        document.body.appendChild(a);
        a.click();
        a.remove();
        this.showToast("Download iniciado");
      },

      saveAsModule() {
        const html = this.refs.htmlEditorTextarea.value || '';
        const newStack = {
          id: Date.now(),
          title: `module-${Date.now()}.html`,
          content: html,
          date: new Date().toLocaleDateString()
        };
        this.state.stacks.unshift(newStack);
        this.saveStacks();
        this.renderStacks();
        this.showToast("Salvo como módulo");
      },

      // --- EVENT BINDING ---

      bindEvents() {
        // Orb Toggle (salva estado)
        this.refs.orbBtn.addEventListener('click', () => {
          this.toggleSystem();
          localStorage.setItem(this.config.stateKey, String(this.state.active));
        });

        // Theme
        document.getElementById('themeToggle').addEventListener('click', () => this.toggleTheme());

        // Quick editor open
        document.getElementById('openEditorBtn').addEventListener('click', () => this.openEditor());
        document.getElementById('quickEditBtn').addEventListener('click', () => this.openEditor());

        // Editor controls
        document.getElementById('closeEditor').addEventListener('click', () => this.closeEditor());
        document.getElementById('loadFromFrame').addEventListener('click', () => this.loadHtmlFromNavFrame());
        document.getElementById('applyToFrame').addEventListener('click', () => this.applyHtmlToNavFrame());
        document.getElementById('downloadHTML').addEventListener('click', () => this.downloadEditorHtml());
        document.getElementById('saveAsModule').addEventListener('click', () => this.saveAsModule());

        // Close editor on ESC
        window.addEventListener('keydown', (e) => {
          if(e.key === 'Escape') {
            if(this.refs.htmlEditorModal.classList.contains('active')) this.closeEditor();
          }
        });

        // Upload
        const upBtn = document.getElementById('uploadBtn');
        const upInput = document.getElementById('uploadHTML');
        upBtn.addEventListener('click', () => upInput.click());
        upInput.addEventListener('change', (e) => {
           if(e.target.files[0]) {
             const url = URL.createObjectURL(e.target.files[0]);
             const modal = document.createElement('my-frame-loader');
             modal.src = url;
             document.body.appendChild(modal);
           }
        });

        // DropZone (Stack Add)
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => {
           if(e.target.files[0]) this.addStack(e.target.files[0]);
        });
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('border-dual-cyan'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('border-dual-cyan'));
        dropZone.addEventListener('drop', (e) => {
          e.preventDefault();
          dropZone.classList.remove('border-dual-cyan');
          if(e.dataTransfer.files[0]) this.addStack(e.dataTransfer.files[0]);
        });

        // Remote URL
        document.getElementById('remoteBtn').addEventListener('click', () => {
          const url = prompt("URL Remota:");
          if(url) {
             const modal = document.createElement('my-frame-loader');
             modal.src = url;
             document.body.appendChild(modal);
          }
        });

        // Decoder
        const decBox = document.getElementById('decoderBox');
        document.getElementById('decoderToggle').addEventListener('click', () => decBox.classList.toggle('hidden'));
        document.getElementById('closeDecoder').addEventListener('click', () => decBox.classList.add('hidden'));
        document.getElementById('decodeBtn').addEventListener('click', () => {
           const val = document.getElementById('codeInput').value.trim().toUpperCase();
           if(this.config.codeMap[val]) {
             const modal = document.createElement('my-frame-loader');
             modal.src = this.config.codeMap[val];
             document.body.appendChild(modal);
             decBox.classList.add('hidden');
             this.showToast(`SELO ABERTO: ${val}`);
           } else {
             this.showToast("SELO INVÁLIDO");
           }
        });

        // Navigation Dots
        document.getElementById('dot-index').onclick = () => { 
           this.refs.navFrame.src = "index.html"; 
           this.showToast("INDEX CARREGADO"); 
        };
        document.getElementById('dot-base').onclick = () => {
           try { this.refs.navFrame.contentWindow.location.reload(); } catch(e) { this.refs.navFrame.src = this.refs.navFrame.src; }
           this.showToast("RESET RITUAL");
        };
        document.getElementById('dot-last').onclick = () => {
           const last = localStorage.getItem(this.config.storageKey);
           if(last) { this.refs.navFrame.src = last; this.showToast("RETOMANDO..."); }
        };

        // Symbol Bar (Right Sidebar)
        document.querySelectorAll('[data-url]').forEach(btn => {
           if(btn.dataset.url) {
             btn.addEventListener('click', () => {
               this.refs.navFrame.src = btn.dataset.url;
               this.showToast(`NAV: ${btn.title}`);
             });
             btn.addEventListener('contextmenu', (e) => {
               e.preventDefault();
               window.open(btn.dataset.url, '_blank');
             });
           }
        });

        // Feature Buttons
        document.getElementById('infodoseBtn').addEventListener('click', () => {
           this.state.infodose = !this.state.infodose;
           if(this.state.infodose) {
             this.refs.pulseBar.style.opacity = '1';
             this.showToast("INFODOSE: LINKED");
           } else {
             this.refs.pulseBar.style.opacity = '0';
             this.showToast("INFODOSE: UNLINKED");
           }
        });

        document.getElementById('ritualBtn').addEventListener('click', () => {
           this.refs.body.classList.add('animate-pulse');
           setTimeout(() => this.refs.body.classList.remove('animate-pulse'), 1000);
           this.showToast("VISUAL RITUAL");
        });

        // Runtime Controls
        document.getElementById('closeRuntimeBtn').onclick = () => this.closeRuntime();
        document.getElementById('openInFrameBtn').onclick = () => {
          if(this.refs.appFrame.srcdoc) {
             const blob = new Blob([this.refs.appFrame.srcdoc], {type: 'text/html'});
             const url = URL.createObjectURL(blob);
             this.refs.navFrame.src = url;
             this.showToast("EXPORTADO PARA FRAME");
             this.closeRuntime();
          }
        };
      }
    };

    // Bootstrap
    window.onload = () => App.init();

  </script>
</body>
</html>